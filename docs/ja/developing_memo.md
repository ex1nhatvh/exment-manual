# 開発メモ
マニュアルとして各画面に記載するには冗長になるものの、開発者として共有はしておきたい、細かい仕様などの雑多なまとめになります。

## 権限「すべてのデータの参照」と「担当者データの編集」などを組み合わせられない理由
現在、特定のテーブルに対し、権限「すべてのデータの参照」と、「担当者データの編集」「担当者データの閲覧」を組み合わせる事ができない。  
その理由は、以下の仕様のため。

#### 前提
権限はマージされ、強い権限の方（「可能にする」系の権限）を優先する。  
例えば、「すべてのデータを取得可能にする」と「自分が共有されたデータのみ取得できる」が組み合わされている場合、「すべてのデータを取得可能にする」が優先される。

#### 権限「すべてのデータの参照」の詳細

- SQL実施時、データ共有によるwhere句を追加せず、すべてのデータを取得可能にする。
- 一覧画面を表示する事ができない。また、メニューに項目を表示することが出来ない。
- データを新規作成・編集する事ができない。

#### 権限「担当者データの編集」の詳細

- SQL実施時、データによるwhere句が実施され、自分が共有されたデータのみ取得できる。
- 一覧画面を表示する事ができる。また、メニューに項目を表示することが出来る。
- データを新規作成・自分が共有されたデータの編集をする事ができる。


#### 結果
この2つの権限を組み合わせた結果、以下のような詳細になる。

- SQL実施時、データ共有によるwhere句を追加せず、すべてのデータを取得可能にする。
- 一覧画面を表示する事ができる。また、メニューに項目を表示することが出来る。
- データを新規作成・自分が共有されたデータの編集する事ができる。

つまり、すべてのデータが一覧画面に表示され、データを新規作成・自分が共有されたデータの編集する事ができる状況になる。  
  
「一覧画面では、すべてのデータを取得可能にせず、自分が共有されたデータのみ取得可能になる。」という記述を各画面に入れることも可能ではあるが、独自プラグインやその他の画面で、すべてその処理を追加しなければならず、脆弱性となりかねない。  
また、この状況は、「すべてのデータの閲覧」と「担当者データの編集」を組み合わせるものとまったく同等である。  
そのため現在、設定として、「すべてのデータの参照」と「担当者データの編集」などを組み合わせることは出来ない。  

#### 「すべてのデータの参照」の用途
用途としては、主に以下のようなものが該当する。  

- 税率  
    →責任者などに、「すべてのデータの参照」と「すべてのデータの編集」権限を持たせ、マスターとしてメンテナンスしていく。  
    →一般ユーザーは、「すべてのデータの参照」のみ持たせ、選択肢としては取得可能にする。




## カスタムデータ削除時の仕様
v4.0.7より見直し。

#### 論理削除時
※復元の可能性があるので、基本的に残しておく  

- カスタム列「ファイル」「画像」のファイル：削除されない
- 添付ファイル：削除されない
- リレーション(1:nで、親データを削除した時の子データ)：論理削除される
- リレーション（それ以外）：削除されない
- 権限制御：削除されない
- リビジョン：削除されず、削除日時の履歴を追加する
- 通知：実施される
- ワークフロー履歴：削除されない

#### 完全に削除時
物理削除する

- カスタム列「ファイル」「画像」のファイル：削除される
- 添付ファイル：削除される
- リレーション：すべて物理削除される
- 権限制御：削除される
- リビジョン：削除される
- 通知：実施されない
- ワークフロー履歴：削除される

#### 即時の物理削除時
※設定値EXMENT_DELETE_FORCE_CUSTOM_VALUEを1にすれば、即物理削除にする

- カスタム列「ファイル」「画像」のファイル：削除される
- 添付ファイル：削除される
- リレーション：すべて物理削除される
- 権限制御：削除される
- リビジョン：削除される
- 通知：実施される
- ワークフロー履歴：削除される



## 関数getOrganizationIdsの結果が、実際の組織とは入れ替わった結果が取得される理由
関数\Exment::user()->getOrganizationIds (getOrganizationIdsForQueryにリネーム予定) では、実際の所属の組織とは、入れ替わった結果が取得されます。  
例えば、以下のような組織構成があったとします。

```
 Ex. (O):Ogganization, (U):User
 
     (O)Company
         (O)develop-team
             (U) Manager
 
             (O) develop-team1
                  (U) User1
                  (U) User2
             (O) develop-team2
                  (U) User3
```

ここで、ログインユーザーがManagerで、$filterTypeがJoinedOrgFilterType::ONLY_UPPERの場合、イメージでは(O)develop-team、(O)Companyが取得されそうですが、  
**実際には(O)develop-team、(O) develop-team1、(O) develop-team2が取得されます。**
  
これは、この関数があくまでも、共有されたデータの取得や、権限のあるデータの取得を目的としているためで、実際の組織を取得することを目的としていないからです。  
例えば、「データAは、(O)develop-team1に共有されている」「データの共有は、親階層の組織を含める(JoinedOrgFilterType::ONLY_UPPER)」という設定の場合、Managerは、(O)develop-team、(O) develop-team1、(O) develop-team2に共有されたデータを取得することになります。  
この場合、クエリの処理上、Managerは、(O)develop-team、(O) develop-team1、(O) develop-team2に所属しているものとみなし、SQLを実施します。  

そのため、Enumの値のイメージと異なり、実際の結果は入れ替わって取得されます。