# ログイン設定
Exmentにログインを行う時の、各種ログイン設定を行います。

> SSOに関する設定・説明は、[こちら](/ja/login_sso)をご確認ください。


## 2段階認証
Exmentでは、2段階認証に対応しています。  
ユーザー情報を入力してログイン後、EメールもしくはGoogle認証システムによって送信されたコードを入力することで、Exmentにアクセスすることができるようになります。  
※2段階認証は、ログイン方式が「標準」「LDAP」の場合に利用できます。

- [2段階認証 システム設定](/ja/login_2factor_setting)
- [ログイン(2段階認証)](/ja/login_2factor)


## ログイン設定管理方法

- システム管理者が、以下のURLを入力します。  
http(s)://(ExmentのURL)/admin/login_setting  
※上記で記載の「システム設定変更」を行うことで、アクセスが出来るようになります。

- もしくは、メニューに「ログイン設定」を追加します。  
「管理者設定」 > 「メニュー」ページを開き、メニュー種類「システムメニュー」を選択すると、対象の「ログイン設定」が表示されますので、選択し、保存を行ってください。  
※「ログイン設定」は、デフォルトの設定ではメニューに表示されません。

![ログイン設定一覧](img/login/login_setting4.png)  

- 2段階認証の管理を行うには、下記のページの手順に従い、設定を行います。

    - [2段階認証 システム設定](/ja/login_2factor_setting)


### パスワードポリシー設定
ログインパスワードに関連するルールを設定します。   

![パスワードポリシー設定画面](img/system_setting/system_setting_password.png)  

#### 複雑なパスワード
- 設定がYESの場合、3種類以上の文字種（半角英大文字、半角英小文字、半角数字、半角記号）を含んだ12文字以上のパスワードを設定する必要があります。
- 初期値は「NO」です。

#### 有効日数
- 指定日数経過後に初めてログインした場合、パスワード変更画面に誘導されます。パスワードを変更してから、再度ログイン処理を行ってください。
- 有効日数を「0」にした場合、パスワードは無期限になります。
- 初期値は「0」です。

#### 初回ログイン時にパスワードを変更させる
- YESにした場合、ユーザーがはじめてログインを行った際に、パスワードを変更させる画面を表示します。
- この設定をYESにした後で、新規登録、またはパスワードをリセットしたユーザーに対し、有効になります。
- この設定をYESにする前に新規登録などを行ったユーザーには、設定が反映されません。
- 初期値は「NO」です。

#### パスワードの履歴件数
- 最近使用したパスワードの再利用を制限します。新しいパスワードと直近～履歴件数分のパスワードを比較して同一だった場合はエラーにします。
- 履歴件数を「0」にした場合は比較対象外です。
- 初期値は「0」です。

#### 注意

- <span class="small">「複雑なパスワード」と「パスワードの履歴件数」は、ユーザー設定画面やパスワードのリセット画面などでユーザー自身がパスワードを設定する場合に適用されます。システム管理者が設定する場合は対象外です。</span>


### その他
- v3.3.0未満からv3.3.0以上にアップデートした場合で、ユーザーコードに「ドット(.)」を含んだプロバイダでログインを行った場合、エラーとなることがあります。  
その場合、以下の対応を行ってください。
    - 「ユーザー」テーブルの「カスタム列設定」で、「ユーザーコード」列の編集画面に遷移する。
    - 「使用可能文字」オプションで、「ドット」にチェックを入れて保存する。


- 既定の動作では、ログイン状態でブラウザを閉じた場合でも、一定時間（120分）経過するまでは、ログイン状態を維持します。  
v3.6.0以降で、ログイン状態でブラウザを閉じた場合に、自動的にログアウトにする場合には、「.env」ファイルを開き、以下のように追記を行ってください。  
※設定ファイルの編集方法について、詳細は[こちら](/ja/config)をご参照ください。

~~~
EXMENT_SESSION_EXPIRE_ON_CLOSE=true
~~~




## パスワードリセットコマンド
パスワードリセットを、コマンドにより実施することができます。

- システム管理者が、コンソールで以下のコマンドを実行します。

~~~
php artisan exment:resetpassword --email=foobar@test.com --password=P@ssw0rd!
~~~

- 上記のコマンドを実行することで、Eメールアドレスが"foobar@test.com"のユーザーに、パスワード"P@ssw0rd!"をセットします。


### コマンドの引数

```
exment:resetpassword {--id=} {--email=} {--user_code=} {--password=} {--random=0} {--send=0} {--reset_first_login=0}
```

#### 引数：ユーザー指定
※下記の引数のうち、いずれかが必須です。下記の引数のうち、複数を選択していた場合、id > email > user_codeの優先度順に検索を行います。

- ##### id
対象のユーザーのログインIDです。

- ##### email
対象のユーザーのEメールアドレスです。

- ##### user_code
対象のユーザーのユーザーコードです。


#### 引数：パスワード
※"password"の指定か、"random=1"のいずれかを指定してください。両方の入力があった場合、"password"引数を優先します。

- ##### password  
変更するパスワード文字列を指定してください。

- ##### random  
パスワード文字列をランダムに作成する場合、1を指定してください。未指定の場合、0。

#### 引数：オプション

- ##### send  
変更後のパスワードを、対象のユーザーにメール送信する場合、1を指定してください。未指定の場合、0。

- ##### reset_first_login  
パスワード変更後、ユーザーがはじめてログインを行った際に、パスワードを変更させる画面を表示します。未指定の場合、0。  
※このオプション指定に関わらず、ログイン設定で「初回ログイン時にパスワードを変更させる」をYESにしていた場合、ユーザーがはじめてログインを行った際に、パスワードを変更させる画面を表示します。

### 特記事項
- 引数で"random=1"を指定し、"send=1"の指定がなかった場合、パスワードリセット後、変更後のパスワードをコンソール表示します。


### コマンド実行例

~~~
# 例 : id1のユーザーに、パスワードを指定してリセット
php artisan exment:resetpassword --id=1 --password=P@ssw0rd!

# 例 : ユーザーコード"user1"のユーザーに、ランダムパスワードをセットし、メール送信する
php artisan exment:resetpassword --user_code=user1 --random=1 --send=1

# 例 : Eメールアドレス"foobar@test.com"のユーザーに、ランダムパスワードをセットする
php artisan exment:resetpassword --email=foobar@test.com --random=1
パスワードをリセットしました。新しいパスワード：XXXXXXXXXX #変更後のパスワードがコンソール出力される
~~~

