# 開発メモ
マニュアルとして各画面に記載するには冗長になるものの、開発者として共有はしておきたい、細かい仕様などの雑多なまとめになります。

## 権限「すべてのデータの参照」と「担当者データの編集」などを組み合わせられない理由
現在、特定のテーブルに対し、権限「すべてのデータの参照」と、「担当者データの編集」「担当者データの閲覧」を組み合わせる事ができない。  
その理由は、以下の仕様のため。

#### 前提
権限はマージされ、強い権限の方（「可能にする」系の権限）を優先する。  
例えば、「すべてのデータを取得可能にする」と「自分が共有されたデータのみ取得できる」が組み合わされている場合、「すべてのデータを取得可能にする」が優先される。

#### 権限「すべてのデータの参照」の詳細

- SQL実施時、データ共有によるwhere句を追加せず、すべてのデータを取得可能にする。
- 一覧画面を表示する事ができない。また、メニューに項目を表示することが出来ない。
- データを新規作成・編集する事ができない。

#### 権限「担当者データの編集」の詳細

- SQL実施時、データによるwhere句が実施され、自分が共有されたデータのみ取得できる。
- 一覧画面を表示する事ができる。また、メニューに項目を表示することが出来る。
- データを新規作成・自分が共有されたデータの編集をする事ができる。


#### 結果
この2つの権限を組み合わせた結果、以下のような詳細になる。

- SQL実施時、データ共有によるwhere句を追加せず、すべてのデータを取得可能にする。
- 一覧画面を表示する事ができる。また、メニューに項目を表示することが出来る。
- データを新規作成・自分が共有されたデータの編集する事ができる。

つまり、すべてのデータが一覧画面に表示され、データを新規作成・自分が共有されたデータの編集する事ができる状況になる。  
  
「一覧画面では、すべてのデータを取得可能にせず、自分が共有されたデータのみ取得可能になる。」という記述を各画面に入れることも可能ではあるが、独自プラグインやその他の画面で、すべてその処理を追加しなければならず、脆弱性となりかねない。  
また、この状況は、「すべてのデータの閲覧」と「担当者データの編集」を組み合わせるものとまったく同等である。  
そのため現在、設定として、「すべてのデータの参照」と「担当者データの編集」などを組み合わせることは出来ない。  

#### 「すべてのデータの参照」の用途
用途としては、主に以下のようなものが該当する。  

- 税率  
    →責任者などに、「すべてのデータの参照」と「すべてのデータの編集」権限を持たせ、マスターとしてメンテナンスしていく。  
    →一般ユーザーは、「すべてのデータの参照」のみ持たせ、選択肢としては取得可能にする。




## カスタムデータ削除時の仕様
v4.0.7より見直し。

#### 論理削除時
※復元の可能性があるので、基本的に残しておく  

- カスタム列「ファイル」「画像」のファイル：削除されない
- 添付ファイル：削除されない
- リレーション(1:nで、親データを削除した時の子データ)：論理削除される
- リレーション（それ以外）：削除されない
- 権限制御：削除されない
- リビジョン：削除されず、削除日時の履歴を追加する
- 通知：実施される
- ワークフロー履歴：削除されない

#### 完全に削除時
物理削除する

- カスタム列「ファイル」「画像」のファイル：削除される
- 添付ファイル：削除される
- リレーション：すべて物理削除される
- 権限制御：削除される
- リビジョン：削除される
- 通知：実施されない
- ワークフロー履歴：削除される

#### 即時の物理削除時
※設定値EXMENT_DELETE_FORCE_CUSTOM_VALUEを1にすれば、即物理削除にする

- カスタム列「ファイル」「画像」のファイル：削除される
- 添付ファイル：削除される
- リレーション：すべて物理削除される
- 権限制御：削除される
- リビジョン：削除される
- 通知：実施される
- ワークフロー履歴：削除される



## 関数getOrganizationIdsForQueryの結果が、実際の組織とは入れ替わった結果が取得される理由
関数\Exment::user()->getOrganizationIdsForQuery では、実際の所属の組織とは、入れ替わった結果が取得されます。  
例えば、以下のような組織構成があったとします。

```
 Ex. (O):Ogganization, (U):User
 
     (O)Company
         (O)develop-team
             (U) Manager
 
             (O) develop-team1
                  (U) User1
                  (U) User2
             (O) develop-team2
                  (U) User3
```

ここで、ログインユーザーがManagerで、$filterTypeがJoinedOrgFilterType::ONLY_UPPERの場合、イメージでは(O)develop-team、(O)Companyが取得されそうですが、  
**実際には(O)develop-team、(O) develop-team1、(O) develop-team2が取得されます。**
  
これは、この関数があくまでも、共有されたデータの取得や、権限のあるデータの取得を目的としているためで、実際の組織を取得することを目的としていないからです。  
例えば、「データAは、(O)develop-team1に共有されている」「データの共有は、親階層の組織を含める(JoinedOrgFilterType::ONLY_UPPER)」という設定の場合、Managerは、(O)develop-team、(O) develop-team1、(O) develop-team2に共有されたデータを取得することになります。  
この場合、クエリの処理上、Managerは、(O)develop-team、(O) develop-team1、(O) develop-team2に所属しているものとみなし、SQLを実施します。  

そのため、Enumの値のイメージと異なり、実際の結果は入れ替わって取得されます。


## プラグインのロード処理
通常、PHPファイルのロードには、autoloadが使用されます。  
これはcomposerにより生成され、プログラム開発者ならびに利用者が意識することはほとんどありません。  
  
しかし、プラグインでインストールするPHPファイルは、autoloadを使用することが出来ません。  
これは、Exmentのプラグインファイルは、AWS S3やFTPなど、外部サービスに配置することが可能で、プラグインファイルの実体がサーバーに存在しないことがあるためです。  
※この機能の詳細は、[こちら](/ja/additional_file_saveplace)をご確認ください  
  
そのため、プラグインのロード処理は、特殊な対応を行っています。  
以下、その詳細になります。  

### プラグインファイルのダウンロード(プラグインファイルを外部サービスに配置していた場合)
プラグインファイルを外部サービスに配置していた場合、ダウンロードを行います。  
以下の判定を行い、必要な場合のみ、ダウンロードを実施します。

- サーバーの、対象のプラグインフォルダ「/storage/app/plugins/(プラグイン名)」に、「updated_at.txt」ファイルがあるかどうかを確認する  
→無い場合、ダウンロード必要

- 「updated_at.txt」ファイルを開き、中に記載しているタイムスタンプを確認する

- データベースのテーブル「プラグイン」の更新日時と比較し、日時が異なるかどうか確認  
→異なる場合、ダウンロード必要

ダウンロードが必要な場合、外部サービスから、プラグインファイルをダウンロードします。  
その後、対象のプラグインフォルダに「updated_at.txt」ファイルを生成し、タイムスタンプを記載します。

### 独自のClassLoaderにディレクトリを追加する
各プラグインファイルをループし、対象のプラグインフォルダと、そのプラグインに合致するネームスペースを、独自の\Exceedone\Exment\Services\ClassLoaderに追加します。

### ロード処理実施
プラグインのクラスが呼び出された時、spl_autoload_registerにより、独自のClassLoaderが呼び出されます。  
これにより、呼び出されたクラスのnamespaceと、対象のプラグインフォルダをキーに、合致するPHPファイルをrequire_onceします。  
この処理によって、未ロードのクラスであっても、動的にクラスを読み込み、require_onceが行われます。




## 列種類「選択肢 (他のテーブルの値一覧から選択)」「ユーザー」「組織」の絞り込み設定
カスタムデータの入力画面で、列種類「選択肢 (他のテーブルの値一覧から選択)」「ユーザー」「組織」で表示される選択肢は、常に全件表示されるわけではありません。  
以下、選択肢の絞り込みパターンを記載します。  
  
※説明のための例として、以下のようなテーブルを想定します。  

- 表示しているテーブル：契約
- 列種類「選択肢 (他のテーブルの値一覧から選択)」によって参照しているテーブル1：顧客
- 列種類「選択肢 (他のテーブルの値一覧から選択)」によって参照しているテーブル2：担当者  
※顧客と担当者テーブルは、1:nの親子関係のリレーション設定


### 列種類「選択肢 (他のテーブルの値一覧から選択)」の絞り込みケース

#### ログインユーザーの権限
参照先のテーブル（顧客）にて、ログインユーザーがアクセスする権限を持っているデータのみ表示されます。  
権限がないデータは、選択肢に表示されません。  

##### この設定の対応方法
想定された選択肢が表示されない場合、以下のいずれかを実施し、権限を追加してください。  

- 選択肢に表示させたい、参照先のテーブル（顧客）のデータに、ログインユーザーへ共有を実施してください。  
詳細：[データ共有](/ja/data_details?id=%e3%83%87%e3%83%bc%e3%82%bf%e5%85%b1%e6%9c%89)

- ログインユーザーが所属する役割グループに、「参照先のテーブル（顧客）」の「全データの編集/閲覧」の権限を追加してください。  
詳細：[役割グループ](/ja/role_group)


#### 列設定「条件ビュー」
列設定「条件ビュー」の設定が行われていた場合、その条件ビューの絞り込み条件に応じて、表示される選択肢が絞り込まれます。  
※条件ビューは、参照先のテーブル（顧客）のデータを絞り込むためのビューです。

##### この設定の対応方法
想定された選択肢が表示されない場合、以下のいずれかを実施してください。  

- 選択肢に表示させたい、参照先のテーブル（顧客）の条件ビューの条件を見直してください。  
詳細：[条件ビュー](/ja/view?id=%e6%9d%a1%e4%bb%b6%e3%83%93%e3%83%a5%e3%83%bc)

- 列設定「条件ビュー」の設定を削除してください。


#### データが100件以上存在する
参照先のテーブル（顧客）のデータが100件以上存在する場合、初期表示では、選択肢が表示されません。  
検索ワードを入力することで、その検索ワードにマッチするデータのみ、選択肢として表示します。   
また、カスタム列設定「選択肢を都度検索する」設定をYESにしていた場合には、データ件数に関わらず、この方式で選択肢が表示されます。  


#### 関連絞り込み設定
カスタムフォームの設定画面で、「関連絞り込み」設定があります。  
これは、親子関係のある選択肢が同じフォーム内にあった場合、親の選択肢(顧客)を選択することで、子の選択肢(担当者)が自動的に絞りまれる機能です。  
詳細：[フォーム設定](/ja/form#関連絞り込み設定)  
 
この設定により、以下のような挙動となります。

- 親(顧客)を選択していない場合の、子(担当者)の選択肢  
→選択肢が1件も表示されない状態となります。

- 親(顧客)を選択していた場合の、子(担当者)の選択肢  
→子(担当者)のデータのうち、親(顧客)の値が、親の選択肢で選択していた値となっているデータを、一覧で表示します。  




### 列種類「ユーザー」「組織」の絞り込みケース

#### 現在表示しているテーブルの、ユーザー・組織の権限
現在表示しているテーブル(契約)に、アクセスを行うことができるユーザー・組織のみ、選択肢に表示されます。  
<span class="red">※ログインしているユーザーの権限は影響しません。</span>「選択肢に表示するユーザー・組織が、現在表示しているテーブルに権限を持っているか」が判定基準になります。  

##### この設定の対応方法
想定された選択肢が表示されない場合、以下のいずれかを実施してください。  

- 役割グループ設定で、「表示しているテーブル（契約）」に権限のある役割グループに対し、「選択肢に表示させたいユーザー・組織」を追加してください。  
詳細：[役割グループ](/ja/role_group)

- カスタム列設定で、「権限をもたないユーザー・組織も表示する」をYESにしてください。  
この設定をYESにすることで、「表示しているテーブル（契約）で、ユーザー・組織が権限を持っているかどうか」のチェックを行わなくなります。


#### 外部ポータルサイト向け設定(複数の組織のユーザーがログインするシステムを構築する場合)
データ一覧画面や編集画面で、ユーザー・組織の表示時、**「ログインユーザーが所属する組織や、その所属ユーザーのみ表示させる」**という設定を行う場合があります。  
この設定が行われていた場合に、ログインユーザーが組織・ユーザーの選択肢を表示する場合は、ログインするユーザーの親子関係にあるユーザー・組織のみ表示します。  
詳細：[外部ポータルサイト向け設定](/ja/multiuser)


#### 列設定「条件ビュー」
列設定「条件ビュー」の設定が行われていた場合、その条件ビューの絞り込み条件に応じて、表示される選択肢が絞り込まれます。  
※条件ビューは、参照先のテーブル（ユーザー）のデータを絞り込むためのビューです。

##### この設定の対応方法
想定された選択肢が表示されない場合、以下のいずれかを実施してください。  

- 選択肢に表示させたい、参照先のテーブル（ユーザー）の条件ビューの条件を見直してください。  
詳細：[条件ビュー](/ja/view?id=%e6%9d%a1%e4%bb%b6%e3%83%93%e3%83%a5%e3%83%bc)

- 列設定「条件ビュー」の設定を削除してください。


#### データが100件以上存在する
参照先のテーブル（ユーザー）のデータが100件以上存在する場合、初期表示では、選択肢が表示されません。  
検索ワードを入力することで、その検索ワードにマッチするデータのみ、選択肢として表示します。   
また、カスタム列設定「選択肢を都度検索する」設定をYESにしていた場合には、データ件数に関わらず、この方式で選択肢が表示されます。  


#### 関連絞り込み設定
カスタムフォームの設定画面で、「関連絞り込み」設定があります。  
これは、親子関係のある選択肢が同じフォーム内にあった場合、親の選択肢(組織)を選択することで、子の選択肢(ユーザー)が自動的に絞りまれる機能です。  
詳細：[フォーム設定](/ja/form#関連絞り込み設定)  
 
この設定により、以下のような挙動となります。

- 親(組織)を選択していない場合の、子(ユーザー)の選択肢  
→選択肢が1件も表示されない状態となります。

- 親(組織)を選択していた場合の、子(ユーザー)の選択肢  
→子(ユーザー)のデータのうち、親(組織)に所属しているデータを、一覧で表示します。  

