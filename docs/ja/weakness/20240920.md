# 脆弱性対応 クロスサイトスクリプティング、ならびにSQLインジェクション

## 概要

### 情報公開日
2022/08/17

### 対象バージョン
- (PHP8)exceedone/exment v6.1.3以下、ならびにexceedone/laravel-admin v4.1.1  


### 発覚経緯
届出により発覚。

### 発生条件
1. 特定のURLもしくは画面で、スクリプトを入力した場合に、スクリプトが実行される。  
1. 特定のURLで、SQLを入力した場合に、スクリプトが実行される。  

※本件の具体的な発生条件は、本脆弱性による悪用を可能な限り防止するため、非公開とさせてください。

### 脆弱性がもたらす脅威
- 被害者のセッションにおいて、再認証を伴わない機能を悪用される。また、ページの見かけ上の改ざんによるフィッシングなどに悪用される。  
- 任意のSQLを実行することで、予期しないデータの取得などを行われる可能性がある。


### 対応方法
以下のいずれかの対応をお願いします。

- (推奨)exceedone/exmentをv6.1.4以上、ならびにexceedone/laravel-adminをv4.1.2以上に更新してください。

### 対応方法(なんらかの事情でアップデートができない場合)
なんらかの事情でアップデートができない場合、以下のファイルの修正をお願いします。

``` php
// vendor/exceedone/exment/resources/lang/en/exment.php
///// 116行目前後
//以下を追加
'not_edit_column_type' => 'The column type cannot be changed.',
```

``` php
// vendor/exceedone/exment/resources/lang/ja/exment.php
///// 116行目前後
//以下を追加
'not_edit_column_type' => '列種類は変更不可です。',
```

``` php
// vendor/exceedone/exment/src/Controllers/AdminControllerTableBase.php
///// 62行目前後
//以下を追加
protected function validateEditColumnType($column, $columnType)
{
    if (is_null($columnType) || $columnType !== $column->column_type) {
        Checker::error(exmtrans("common.message.not_edit_column_type"));
        return false;
    }
    return true;
}
```

``` php
// vendor/exceedone/exment/src/Controllers/CustomColumnController.php
///// 82行目前後
//以下を追加
/**
 * Update the specified resource in storage.
 *
 * @param int $id
 *
 * @return \Illuminate\Http\Response
 */
public function update($tableKey, $id)
{   
    //Validation table value
    if (!$this->validateTable($this->custom_table, Permission::CUSTOM_TABLE)) {
        return;
    }
    if (!$this->validateTableAndId(CustomColumn::class, $id, 'column')) {
        return;
    }
    if (request()->has('column_type')) {
        $column_type = request()->get('column_type');
        $column = $this->custom_columns->first(function ($value) use ($id) {
            return $value->id == $id;
        });
        if (!$this->validateEditColumnType($column, $column_type)) {
            return;
        }
    }

    return $this->form($id)->update($id);
}
```

``` php
// vendor/exceedone/exment/src/Controllers/CustomTableController.php
///// 667行目前後
//以下を追加
if (!$this->validateTable($id, Permission::CUSTOM_TABLE)) {
    return;
}
```

#### ファイル差し替え
以下のファイルは、修正箇所が多いため、該当ファイルのバックアップの上、ファイルの差し替えをお願い致します。
- vendor\exceedone\exment\src\Form\Field\SwitchField.php
- vendor\exceedone\laravel-admin\src\Grid\Column.php
- vendor\exceedone\laravel-admin\src\Grid\Model.php
    - [PHP8版](https://exment.net/downloads/weakness/20220819/php8.zip)
    - [PHP7版](https://exment.net/downloads/weakness/20220819/php7.zip)


  
[←一覧へ戻る](/ja/patch_weakness)